# Copyright (C) 2008 Michael Homer <=mwh>
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
import sys
from PythonUtils import *

class FreshenArgParser(object):
	def __init__(self, ui):
		self.fetched = False
		self.ui = ui
		self.fetch()

	def fetch(self):
		if self.fetched:
			return
		self.fetched = True
		self.skipSet = set()
		self.examineSet = set()
		self.mode = 'updating'
		self.noCache = False
		self.forceCache = False
		self.action = self.ui.showUpdates
		self.limit = None
		self.types = []
		
		catching = self.examineSet
		singleCatch = ''
		for arg in sys.argv[1:]:
			if arg=='-x' or arg=='--exclude':
				catching = self.skipSet
			else:
				# Reset catching to examineSet if we hit a non-list option
				reset = True
				if arg=='--thorough':
					self.mode = 'all'
				elif arg=='--no-cache' or arg=='-C':
					self.noCache = True
				elif arg=='--force-cache' or arg=='-c':
					self.forceCache = True
				elif arg=='--shallow' or arg=='-s':
					self.mode = 'missing'
				elif arg=='--install':
					self.mode = 'missing'
					self.action = self.ui.installUpdates
				elif arg=='--limit' or arg=='-l':
					singleCatch = 'limit'
				elif arg=='-r' or arg=='--recipe':
					self.types.append('recipe')
				elif arg=='-p' or arg=='--package':
					self.types.append('official_package')
				elif arg=='--contrib':
					self.types.append('contrib_package')
				elif arg=='-U':
					self.action = self.ui.installUpdates
				elif arg=='--help':
					self.action = self.ui.showHelp
				elif arg=='--version':
					self.action = self.ui.showVersion
				elif arg=='--no-colour':
					for c in Screen.colours:
						Screen.colours[c] = ''
				elif arg=='--':
					# To allow breaking out of multi-argument sections into the examine list
					# e.g. Freshen -x foo bar -- baz quux
					catching = self.examineSet
				elif singleCatch:
					self.__dict__[singleCatch] = arg
					singleCatch = ''
				elif arg[0:2]=='--':
					Log_Error("Invalid argument "+arg, 'Freshen')
					exit()
				else:
					catching.add(arg)
					reset = False
				if reset: catching = self.examineSet
		if self.limit is not None:
			try:
				self.limit = int(self.limit)
			except ValueError:
				Log_Error("--limit must be passed an integer (not %s)."%(self.limit), 'Freshen')
				exit(1)
		self.progString = ', '.join(self.examineSet)
		self.examineSet = frozenset(self.examineSet)
		self.skipSet = frozenset(self.skipSet)
